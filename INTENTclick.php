<?php

/*
Plugin Name: INTENTclick Official Plugin
Plugin URI: http://www.INTENTclick.com
Description: This plugin will add your INTENTclick JavaScript code to your blog
Version: 3.2 
Author: INTENTclick
Author URI: http://www.INTENTclick.com

////////////////////////////////
INTENTclick Plug-In License Agreement
////////////////////////////////

This INTENTclick Plug-In License Agreement (“Agreement’) is a legal agreement between you (“Publisher”) and INTENTclick
Technologies, Inc. (“INTENTclick”). YOU MUST READ AND AGREE TO THE TERMS OF THIS AGREEMENT
BEFORE YOU CAN IMPLEMENT AND BEGIN USING THE INTENTclick PLUG-IN. BY USING, REPRODUCING
OR MODIFYING THE INTENTclick PLUG-IN IN ANY WAY, YOU HEREBY AGREE TO THE TERMS AND
CONDITIONS OF THIS AGREEMENT. IF YOU DO NOT AGREE WITH THE TERMS AND CONDITIONS OF
THIS AGREEMENT, THEN YOU SHOULD NOT USE, REPRODUCE, MODIFY THE INTENTclick PLUG-IN IN
ANY WAY.
1. Definitions.
1.1. “INTENTclick Plug-In” means the plug-in that facilitates Publisher’s implementation of tags on the Publisher
Webpages.
1.2. “Publisher Web Pages” means all of the web pages in the domain(s) owned or controlled by Publisher.
2. INTENTclick Plug-In License.
2.1. Grant. Subject to the terms and conditions of this Agreement, INTENTclick grants to Publisher a nonsublicensable,
non-exclusive, non-transferable license to use, reproduce and modify the INTENTclick Plug-In but
solely on the Publisher Web Pages.
2.2. Restrictions and Ownership. Publisher shall not: (i) use the INTENTclick Plug-In for the purposes of developing a
product that will be owned by a third party or that would compete with INTENTclick’s products or services;
(ii) sublicense, rent, lend, lease, permit third party access to, or use of, the INTENTclick Plug-In; (iii) copy,
distribute, reproduce, sell, use or allow access to the INTENTclick Plug-In, except as explicitly permitted under this
Agreement; or (iv) remove, obscure, or alter INTENTclick’s copyright notice, trademarks, or other proprietary rights
notices affixed to or contained within the INTENTclick Plug-In. As between the parties, except for the explicit
license granted herein, INTENTclick, or its licensors, shall retain all right, title and interest in and to the INTENTclick
Plug-In. This is license, not a sale, so title to the INTENTclick Plug-In shall not pass to Publisher under any
circumstances. INTENTclick does not grant to Publisher any license, express or implied, under the intellectual
property of INTENTclick or its licensors except as expressly stated in this Agreement.
3. Confidentiality. “Confidential Information” means any information disclosed by INTENTclick to Publisher, either
directly or indirectly in writing, orally or by inspection of tangible objects which is either (i) designated or marked
as “Confidential” at the time of disclosure, or (ii) disclosed under circumstances reasonably indicating that such
information is confidential. Without limiting the foregoing, the INTENTclick Plug-In, all information relating to the
INTENTclick Plug-In, and the terms and conditions of this Agreement shall be deemed the Confidential Information of
INTENTclick. During the term of this Agreement and for three (3) years following the expiration or termination of this
Agreement, (A) Publisher agrees that it shall not use any Confidential Information other than as expressly permitted
under the terms of this Agreement or as expressly authorized in writing by INTENTclick, (B) Publisher shall use the same
degree of care to protect Confidential Information as it uses to protect its own most highly confidential information,
but in no circumstances less than reasonable care, and (C) Publisher shall not disclose Confidential Information to
any person or entity other than its officers, employees and consultants who need access to such Confidential
Information in order to effect the intent of this Agreement and who have entered into written confidentiality
agreements with it consistent with this Section 3.
4. Term and Termination. Unless earlier terminated as set forth herein, this Agreement is effective from the Effective
Date through the first anniversary of the Effective Date. After such time, this Agreement will automatically renew
for successive twelve (12) month terms unless either party notifies the other party that such party will not renew the
Agreement within thirty (30) days of the end of the then-current term. Either party may terminate this Agreement for
any reason or for no reason at any time upon thirty (30) days notice to the other party. The following sections will
survive any expiration or termination of this Agreement: 2.2, 3, 4, 5, 6 and 7.
5. Disclaimer of Warranties. THE INTENTclick PLUG IN IS PROVIDED “AS IS” AND WITHOUT
REPRESENTATIONS, WARRANTIES OR CONDITIONS, WHETHER EXPRESS, IMPLIED, STATUTORY
OR OUT OF A COURSE OF DEALING OR USAGE OF TRADE, INCLUDING BUT NOT LIMITED TO
IMPLIED WARRANTIES OR CONDITIONS OF MERCHANTABILITY, MERCHANTABLE QUALITY,
-2-
FITNESS FOR ANY PARTICULAR PURPOSE OR USE, NONINFRINGEMENT, QUALITY,
PRODUCTIVENESS OR CAPACITY, AND ALL SUCH WARRANTIES ARE HEREBY DISCLAIMED.
INTENTclick, ITS SUPPLIERS, LICENSORS, AND PARTNERS DO NOT WARRANT THAT THE FUNCTIONS
OF THE INTENTclick PLUG-IN WILL BE CORRECT, UNINTERRUPTED OR ERROR-FREE, THAT DEFECTS
WILL BE CORRECTED, OR THAT THE INTENTclick PLUG-IN IS FREE OF VIRUSES OR OTHER HARMFUL
COMPONENTS. INTENTclick MAKES NO GUARANTEE REGARDING THE NUMBER, QUALITY, OR
CONTENT OF ANY ADVERTISEMENTS OR THE TIMING OF DELIVERY OF SUCH ADVERTISEMENTS
FOLLOWING USE OF THE INTENTclick PLUG-IN. THE FOREGOING DISCLAIMER OF WARRANTY IS A
FUNDAMENTAL PART OF THE BASIS OF INTENTclick’S BARGAIN HEREUNDER, AND THAT INTENTclick
WOULD NOT ENTER INTO THIS AGREEMENT ABSENT SUCH DISCLAIMER.
6. Limitation of Liability. INTENTclick SHALL NOT BE LIABLE FOR ANY CONSEQUENTIAL, INCIDENTAL,
INDIRECT, PUNITIVE, SPECIAL OR OTHER SIMILAR DAMAGES NOR FOR ANY LOSS OF PROFITS,
LOSS OF REVENUES, LOSS OF SAVINGS, LOSS OF CLIENTELE, LOSS OF USE OR LOSS OR
CORRUPTION OF DATA, WHETHER UNDER TORT, CONTRACT OR OTHER THEORIES OF RECOVERY,
EVEN IF SUCH PARTY WAS OR SHOULD HAVE BEEN AWARE OR WAS ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES, AND IN NO EVENT WILL EITHER PARTY’S LIABILITY ARISING
OUT OF THIS AGREEMENT FROM ANY CAUSE OF ACTION WHATSOEVER WILL EXCEED THE
AGGREGATE AMOUNTS ACTUALLY PAID UNDER THIS AGREEMENT BY INTENTclick TO PUBLISHER
DURING THE THREE (3) MONTHS PRIOR TO THE DATE THE CAUSE OF ACTION AROSE.
7. Miscellaneous. This Agreement is the entire agreement between the parties on the subject matter hereof. No
amendment or modification hereof will be valid or binding upon the parties unless made in writing and signed by the
duly authorized representatives of both parties. The relationship of the parties hereunder is that of independent
contractors, and this Agreement will not be construed to imply that either party is the agent, employee, or joint
venturer of the other. In the event that any provision of this Agreement is held to be unenforceable, the Agreement
will continue in full force and effect without such provision and will be interpreted to reflect the original intent of
the parties. This Agreement will be governed by the law of the State of California, without regard to its conflict of
laws principles. The parties consent to the personal and exclusive jurisdiction of courts located in San Francisco,
California. Neither party may assign any of its rights or obligations under this Agreement without the prior written
consent of the other, except that either party may assign any of its rights and obligations under this Agreement
without consent of the other party in connection with any merger, consolidation, reorganization, sale of all or
substantially all of its assets related to this Agreement or other similar transaction. This Agreement shall inure to the
benefit of and shall be binding on each party’s permitted assignees, transferees and successors. Wavier by either
party of a breach of any provision of this Agreement or the failure by either party to exercise any right hereunder
will not operate or be construed to be a waiver of any subsequent breach of any right or as a waiver of any other
right. Except for the payment of fees hereunder, nonperformance of either party will be excused to the extent that
performance is rendered impossible by strike, fire, flood, earthquake, governmental acts or orders or restrictions, or
any other reason when failure to perform is beyond the reasonable control of the nonperforming party.

*/
include_once "functions.php";

define('INTENTclick_ADSON_FULLPAGE','1');
define('INTENTclick_ADSON_CONTENT_ONLY','2');
define('INTENTclick_ADSON_COMMENT_ONLY','3');

register_activation_hook(__FILE__, 'INTENTclick_add_defaults');
register_uninstall_hook(__FILE__, 'INTENTclick_delete_plugin_options');

/**
 * Set INTENTclick default settings and parameters
 */
function INTENTclick_add_defaults() {
	add_option('INTENTclick_post_settings', '1');
	add_option('INTENTclick_publisher_id', '');
	add_option('INTENTclick_adlinkcolor', '#fe9800'); //maybe don't want the hash
	add_option('INTENTclick_disabled_pages', '');
	add_option('INTENTclick_immediately_list', '');
	add_option('INTENTclick_contentLinks_homepage', '1'); 
	add_option('INTENTclick_adson', '1');
	add_option('INTENTclick_disable_new_days', '0');
	
	//if the option is already exists, set it to 1
	update_option('INTENTclick_adson', '1');
}

/**
 * delete INTENTclick options from database
 */
function INTENTclick_delete_plugin_options() {
	delete_option('INTENTclick_post_settings');
	delete_option('INTENTclick_publisher_id');
	delete_option('INTENTclick_adlinkcolor');
	delete_option('INTENTclick_disabled_pages');
	delete_option('INTENTclick_immediately_list');
	delete_option('INTENTclick_contentLinks_homepage');
	delete_option('INTENTclick_adson');
	delete_option('INTENTclick_disable_new_days');
}

/**
 * Add INTENTclick css file to the admin side header
 */
function load_INTENTclick_wp_admin_style(){
        wp_register_style( 'INTENTclick_admin_css', plugins_url( 'css/style.css', __FILE__ ) , false, '1.0.0' );
        wp_enqueue_style( 'INTENTclick_admin_css' );
}

/**
 * Add INTENTclick js file to the admin side header
 */
function INTENTclick_enqueue() {
    wp_enqueue_script( 'INTENTclick_admin_script', plugins_url('/js/INTENTclick.js', __FILE__) );
}

/**
 * Add INTENTclick ContentLinks column to the post list ui
 */
add_filter('manage_posts_columns', 'INTENTclick_columns');

function INTENTclick_columns($columns) {
	$new_columns['cb'] = $columns['cb'];
	$new_columns['title'] = $columns['title'];
	$new_columns['author'] = $columns['author'];
	$new_columns['categories'] = $columns['categories'];
	$new_columns['INTENTclick'] = 'INTENTclick text links';
	$new_columns['tags'] = $columns['tags'];
 	$new_columns['comments'] = $columns['comments'];
	$new_columns['date'] = $columns['date'];

    return $new_columns;
}

function INTENTclick_show_columns( $name ) {
    global $post;
    $post_id = $post->ID;
    switch ($name) {
        case 'INTENTclick':
           if(!INTENTclick_is_page_enabled($post_id)){
			echo 'Never';
           } else if(INTENTclick_is_page_show_immediately($post_id)){
			echo 'Immediately';
           } else {
          	echo 'Using Global Settings';
           }
           break;
	}
}

/**
 * Add INTENTclick control to quick edit box
 */
function INTENTclick_add_quick_edit($column_name) {
    global $post;
	if ($column_name != 'INTENTclick') return;
	?>
    <fieldset class="inline-edit-col-left INTENTclick_add_quick_edit">
	<div class="inline-edit-col">
		<input type="hidden" name="INTENTclick_show_contentLinks_noncename" id="INTENTclick_show_contentLinks_noncename" value="" />
		<input type="checkbox" name="show_contentLinks" id="show_contentLinks" checked="checked" />
		<span class="title">INTENTclick text links</span>
	</div>
    </fieldset>
	<?php 
}
 
/**
 * Save quick edit settings
 */
function INTENTclick_save_quick_edit_data($post_id) {
	// verify if this is an auto save routine. If it is our form has not been submitted, so we dont want
	// to do anything
	if ( defined('DOING_AUTOSAVE') && DOING_AUTOSAVE ) 
		return $post_id;	
	// Check permissions
	if ( isset($_POST['post_type']) && 'page' == $_POST['post_type'] ) {
		if ( !current_user_can( 'edit_page', $post_id ) )
			return $post_id;
	} else {
		if ( !current_user_can( 'edit_post', $post_id ) )
		return $post_id;
	}	
	// OK, we're authenticated: we need to find and save the data
	$post = get_post($post_id);
	if (isset($_POST['show_contentLinks']) && ($post->post_type != 'revision')) {
		$widget_set_id = esc_attr($_POST['show_contentLinks']);
		if ($widget_set_id == 'on'){
			unblock_post($post_id);		
		} else {	
			block_post($post_id);	
		}	
	} else {
		$widget_set_id = 0;
	}
	return $widget_set_id;	
}

/**
 * Add INTENTclick control to bulk edit box
 */
function INTENTclick_quick_edit_bulk( ) {
	?>
	<fieldset class="inline-edit-col-right">
	<div class="inline-edit-col INTENTclick_quick_edit_bulk">
		<div class="inline-edit-group">
			<label for="eventdate" style="font: italic 12px Georgia, serif; float: left; margin-right: 14px;">INTENTclick text links</label>
			<span class="input-text-wrap" style="float: left;">
				<select name="INTENTclick_bulk_edit" >
					<option value="-1" >&mdash; No Change &mdash;</option>
					<option value="2" >Show Immediately</option>
					<option value="1" >Use Global Settings</option>
					<option value="0" >Never Show</option>
				</select>
			</span>
		</div>
	</div>
	</fieldset>
	<?php
}        

/**
 * Save the bulk edit new settings
 */
if(isset($_GET['post'])){
	$post_ids = isset($_GET['post']) ? array_map( 'intval', (array) $_GET['post'] ) : explode(',', $_GET['ids']);
	foreach( (array) $post_ids as $post_id ) {
		if(isset($_GET['INTENTclick_bulk_edit'])){
			$meta_val = $_GET['INTENTclick_bulk_edit'];
			if($meta_val == "0"){
				block_post($post_id);
				remove_post_from_immediately_list($post_id);
			} else if($meta_val == '1') {
				unblock_post($post_id);
				remove_post_from_immediately_list($post_id);
			} else if($meta_val == '2') {
				unblock_post($post_id);
				add_post_to_immediately_list($post_id);
			}
		}
	}
}

/**
 * This function echoes the INTENTclick javascript for the configured user
 */
function INTENTclick_echo_javascript() {
	global $post;
	$post_id = $post->ID;
	$INTENTclick_current_page_is_home = is_home();
	$INTENTclick_ads_disabled_on_page = ((INTENTclick_is_young_post() && !INTENTclick_is_page_show_immediately($post_id) ) || !INTENTclick_is_page_enabled($post_id));


	if(($INTENTclick_current_page_is_home && get_option('INTENTclick_contentLinks_homepage') == 1 ) || (!$INTENTclick_current_page_is_home && !$INTENTclick_ads_disabled_on_page && is_single())) {
	    // get the user's settings
	    $publisher_id = get_option('INTENTclick_publisher_id');
	    $ad_link_color = get_option('color_value','#0000ff');

		?>	
		<!-- INTENTclick(R); - Generated by Wordpress Plugin -->
    	<script type="text/javascript">
		var dc_AdLinkColor = '<?php echo $ad_link_color ?>';
		var dc_PublisherID = <?php echo $publisher_id ?>;
		var dc_IntentClick = true; 
   	 	</script>
		<script type="text/javascript" SRC="http://kona.kontera.com/javascript/lib/KonaLibInline.js"></script>
		<!-- end INTENTclick(R) -->
    	<?php
	}
}

/**
 * Adds the INTENTclick Settings menu to the Options page
 */
function INTENTclick_menu() {
	//add_options_page('INTENTclick Settings', 'INTENTclick Settings', manage_options, __FILE__, 'INTENTclick_options_menu');
	add_menu_page('INTENTclick Settings', 'INTENTclick Settings', 'manage_options', __FILE__, 'INTENTclick_options_menu', plugins_url( 'favicon.png', __FILE__ ));
}

/**
 * Output the options menu page, including the form that updates the user's settings
 */
function INTENTclick_options_menu() {

	if (isset($_POST['INTENTclick_publisher_id'])){
		$isValidPublisherId = (preg_match('/^\d{3,}$/', $_POST['INTENTclick_publisher_id']));
	} else {
		$isValidPublisherId = false;
	}
	
	if (isset($_POST['INTENTclick_disable_new_days'])){
		$isValidBlockDays = (preg_match('/^\d+$/', $_POST['INTENTclick_disable_new_days']));
	} else {
		$isValidBlockDays = false;
	}
	
	if (isset($_POST['new_block_post'])){
		$isValidPostID = isValidPostID($_POST['new_block_post']);
	} else {
		$isValidPostID = false;
	}
	
	if (isset($_POST['action']) && $_POST['action'] == 'update'){
		if($isValidPublisherId) {
			update_option('INTENTclick_publisher_id', $_POST['INTENTclick_publisher_id']);
		}
		if($isValidBlockDays) {
			update_option('INTENTclick_disable_new_days', $_POST['INTENTclick_disable_new_days']);
		}

		if (isset($_POST['new_block_post']) && $_POST['new_block_post'] != '') {
			if($isValidPostID) {
				block_post($_POST['new_block_post']);
			}
		} else {
			$isValidPostID = 1;
		}
		
		if (isset($_POST['INTENTclick_show_contentLinks_homepage']) && $_POST['INTENTclick_show_contentLinks_homepage'] == 'on'){
			update_option('INTENTclick_contentLinks_homepage', '1');
		} else {
			update_option('INTENTclick_contentLinks_homepage', '0');
		}
	
		if (isset($_POST['show_contentLinks_control']) &&  $_POST['show_contentLinks_control'] == 'on'){
			update_option('INTENTclick_adson', '1');
		} else {
			update_option('INTENTclick_adson', '0');
			$isValidBlockDays = 1;
		}
	
		if (isset($_POST['INTENTclick_post_settings']) && $_POST['INTENTclick_post_settings'] != get_option('INTENTclick_post_settings')){
			update_option('INTENTclick_post_settings', $_POST['INTENTclick_post_settings']);
		}
		if (isset($_POST['color_value'])){
			update_option('color_value', $_POST['color_value']);
		}
	} else {
		$isValidPublisherId = $isValidBlockDays = $isValidPostID = 1;
	}
	
	if(get_option('INTENTclick_publisher_id') == ''){
		$curr_publisher_id = 'Enter your publisher ID here';
	} else {
		$curr_publisher_id = get_option('INTENTclick_publisher_id');
	}
		
	// define plugin parameters and descriptions
	$parameters = array (
		'INTENTclick_publisher_id' => 'Publisher ID:',
		'INTENTclick_homepage_settings' => 'Homepage Settings:',
		'INTENTclick_post_settings' => 'Post Settings:',
		'INTENTclick_disabled_pages' => 'Block Posts:',
	
		);
	
	
    echo "<div class='wrap' dir='ltr'><h2> INTENTclick Global Settings </h2><form method='post' action='' name='INTENTclick' ><table class='main_settings'>";

	//Publisher ID
	echo "<tr><td class='headline'><h3> $parameters[INTENTclick_publisher_id] </h3></td> <td class='content'><input type='text' name='INTENTclick_publisher_id' value='".$curr_publisher_id."' /> ", (!$isValidPublisherId) ? "<font style=' color:red'>Please enter a valid publisher id</font>" : "", "</br>Visit the <a href='https://publishers.INTENTclick.com/' target='_blank'>Publisher Center</a> to find your ID.</td></tr>";
	
	//Homepage Settings
	echo "<tr style=\"background: #EFEFEF;\"><td><h3> $parameters[INTENTclick_homepage_settings] </h3></td><td><input type=\"checkbox\" name=\"INTENTclick_show_contentLinks_homepage\" ";
		if(get_option('INTENTclick_contentLinks_homepage') == '1' ){
			echo "checked=\"checked\"";
		}
	echo "/> Show INTENTclick text links </td></tr>";
	
	//Post Settings
	echo "<tr><td class='headline'><h3>$parameters[INTENTclick_post_settings]</h3></td><td><input type=\"checkbox\" name=\"show_contentLinks_control\" onclick=\"checkboxenable()\" ";
		if(get_option('INTENTclick_adson') == '1' ){
			echo "checked=\"checked\"";
		}
	$curr_post_settings = get_option('INTENTclick_post_settings');
	echo "/> Show INTENTclick text links 
			<select name=\"INTENTclick_post_settings\" class=\"INTENTclick_post_settings\">
				<option value=\"1\"";
				if($curr_post_settings == '1'){ echo "selected='selected'" ;}
				echo ">on post and comments</option>
				<option value=\"2\"";
				if($curr_post_settings == '2'){ echo "selected='selected'" ;}
				echo ">on post only</option>
				<option value=\"3\"";
				if($curr_post_settings == '3'){ echo "selected='selected'" ;}
				echo ">on comments only</option>
			</select></td></tr>";
	echo "<tr><td> </td> <td>Posts may show links after <input type='text' name='INTENTclick_disable_new_days' class='INTENTclick_disable_new_days' value='" . get_option('INTENTclick_disable_new_days', 0) . "' /> days. ", (!$isValidBlockDays) ? "<font style=' color:red'>Please enter a valid number of days</font>" : "", "</td></tr>";
	echo "<tr><td> </td> <td>Use the INTENTclick settings on the individual  posts to override this global setting.</td></tr>";
	
	//Block Posts
	echo "<tr style=\"background: #EFEFEF;\"><td class='headline'><h3> $parameters[INTENTclick_disabled_pages] </h3></td> <td>These posts are currently blocked from showing INTENTclick text links:</br><div class='INTENTclick_block_pages'>";
				//<textarea name='INTENTclick_disabled_pages' class='INTENTclick_disabled_pages' readonly='readonly'>";
				$disabled_pages = get_option('INTENTclick_disabled_pages');
				if(!empty($disabled_pages)){
					$disabled_pages = explode(',', $disabled_pages);
					foreach ($disabled_pages as $id) {
						if($id != ''){
							$post = get_post($id); 
							$title = $post->post_title;
							echo "<li id='block_post' class='".$id."'><a class='blocked_post' id='".$id."'><img src='".plugins_url()."/INTENTclick/no.png' /></a>".$title." (".$id.")</li>";
						}
					}
				} else {
					echo "<b>No blocked posts</b>";
				}
				
	//echo "</textarea></td></tr>";
	echo "</div></td></tr>";
	echo "<tr style=\"background: #EFEFEF;\"><td></td> <td>To add a post to this list, enter the ID of the post:</br><input type='text' name='new_block_post' class='new_block_post'/><input type='submit' class='blocksubmit' value='Block'/>", (!$isValidPostID) ? "</br><font style=' color:red'>It appears that the post doesn't exist. Please enter the ID of a post that has been published.</font>" : "","</td></tr>"; 
	
	//Links Settings
	?>	
	<script src="<?php echo plugins_url(); ?>/INTENTclick/js/palette.js" type="text/javascript"></script>
	<link href="<?php echo plugins_url(); ?>/INTENTclick/css/palette.css" media="screen" rel="stylesheet" type="text/css" />
	<tr>
		<td class='headline'>
			<label for="s_color"><h3>Links Settings</h3></label>
		</td>
		<td>
			<input type="text"  id="color_value" name="color_value"  class="INTENTclick_color_select" value="<?php echo get_option('color_value','#fe9800') ?>"/>
			<div  id="color_preview" onclick="openPalette('color_preview')" style="color:<?php echo get_option('color_value','#fe9800') ?>;">Select a color </div>
		</td>
	</tr>
	</table>
	
	<?php 
		// this is needed for some wordpress thing to show which parameters are we updating
		$page_options = implode(',', array_keys($parameters));
	?>

	<!-- palette hidden div -->
    <div id="palette">
        <h2 style="padding:0pt 20px 7px 0pt;">Choose link color</h2>
		<table id="swatches" cellpadding="0" cellspacing="0">
        	<script type="text/javascript">
                createRows('5','14');
        	</script>
		</table>
		<img src="<?php echo plugins_url(); ?>/INTENTclick/pal_cancel.gif" border="0" width="48" height="15" style="float:left; padding: 5px 0 0 8px;"    onclick="pal_reset()" />
		<img src="<?php echo plugins_url(); ?>/INTENTclick/pal_ok.gif" border="0" width="48" height="15" style="float:right;  padding: 5px 8px 0 0;" onclick="setVal()"/>

	</div>	
	<input type="hidden" name="page_options" value="<?php echo $page_options ?>" />
	<input type="hidden" name="action" value="update" />
	<BR>	
	<p class="submit">
		<input class="button-primary submit-settings" type="submit" name="Submit" value="<?php _e('Update INTENTclick Settings &raquo;') ?>" />
	</p>
</form>	 
</div>
<?php

}

/**
 * This function add the "KonaBody" class to the content according to the post settings
 */
function INTENTclick_add_zone_tag_to_content($text) {
	global $post;
	$post_id = $post->ID;
	$INTENTclick_current_page_is_home = is_home();
	$INTENTclick_ads_disabled_on_page = ((INTENTclick_is_young_post() && !INTENTclick_is_page_show_immediately($post_id)) || !INTENTclick_is_page_enabled($post_id));
	
	if(INTENTclick_is_ad_enabled()) {
		if($INTENTclick_current_page_is_home){
			if(get_option('INTENTclick_contentLinks_homepage') == 1 && !$INTENTclick_ads_disabled_on_page){
				return '<div class="KonaBody">' . $text . '</div>';
			} else {
				return '<div class="KonaBody"><div class="KonaFilter">' . $text . '</div></div>'; //will make sure that the homepage will have at list one KonaBody class
			}
		} elseif (!$INTENTclick_ads_disabled_on_page) {
			return '<div class="KonaBody">' . $text . '</div>'; 
		}
	}
	return $text;
}

/**
 * Checks if INTENTclick is enabeld
 */
function INTENTclick_is_ad_enabled() {
	return (get_option('INTENTclick_adson') == '1');
}

/**
 * Show Kontra post control in the post ui
 */
function INTENTclick_block_content_link() {
    global $post;
    $post_id = $post->ID;
	if(get_post_type( $post_id ) == 'post' ){
	?>
	<div class="postbox">
		<h3 class="hndle"><span>INTENTclick text links</span></h3>
			<div class="inside" name="INTENTclick_post">
				<?php
				$checked = '';
				if(INTENTclick_is_page_enabled($post_id)) {
					$checked = 'checked="checked"';
				}
				echo '<input type="checkbox" name="display_content_link" '.$checked.' onclick="checkboxenable()"/> Show INTENTclick ContenLink';
				echo '<select name="INTENTclick_post_settings" class="INTENTclick_post_settings" >';
				echo '<option value="1" ';
				if(!INTENTclick_is_page_show_immediately($post_id)){ echo 'selected="selected"' ;}
				echo '>Using The Global Settings</option>
					<option value="2" ';
				if(INTENTclick_is_page_show_immediately($post_id)){ echo 'selected="selected"' ;}
				echo '>Immediately</option>
					</select></br></br>';
				$days = get_option('INTENTclick_disable_new_days');
				if(get_option('INTENTclick_adson')){
					if($days > 0){
						echo 'Your current Global Setting is to show links after '.$days.' days.';
					} else {
						echo 'Your current Global Setting is to show links immediately';
					}
				} else {
					echo 'Your current Global Setting is not to show any text links';
				}
				?>
			</div>
	</div>

	<?php
	}
}

/**
 * Update INTENTclick option according to the post control box
 */
function INTENTclick_write_post() {
    if($_POST){
        $post_id = $_POST['post_ID'];
        if(isset($_POST['display_content_link'])){
	    	$display_content_link = $_POST['display_content_link'];
			$single_post_settings = $_POST['INTENTclick_post_settings'];
	    	if ($single_post_settings == '2') {
	    	unblock_post($post_id);
	    	add_post_to_immediately_list($post_id);
	    	} else {
            unblock_post($post_id);
            remove_post_from_immediately_list($post_id);
	    	}
        } else {
        	block_post($post_id);
            remove_post_from_immediately_list($post_id);
        }
    }
}

/**
 * This function call the "INTENTclick_add_zone_tag_to_content" to place the KonaBody class in the right content
 */
function addKonaBodyClass(){
	if(get_option('INTENTclick_post_settings') == INTENTclick_ADSON_FULLPAGE){
		add_filter('the_content', 'INTENTclick_add_zone_tag_to_content'); 
		add_filter('comment_text', 'INTENTclick_add_zone_tag_to_content'); 
	} elseif (get_option('INTENTclick_post_settings') == INTENTclick_ADSON_CONTENT_ONLY){
		add_filter('the_content', 'INTENTclick_add_zone_tag_to_content'); 
	} elseif (get_option('INTENTclick_post_settings') == INTENTclick_ADSON_COMMENT_ONLY){
		add_filter('comment_text', 'INTENTclick_add_zone_tag_to_content'); 
	}
}

/**
 * if INTENTclick is enabled load the INTENTclick javascript to the page footer
 */
if(INTENTclick_is_ad_enabled()){
	add_action('wp_footer', 'INTENTclick_echo_javascript');
}


/**
 * Add actions
 */
add_action('template_redirect', 'addKonaBodyClass');
add_action('admin_enqueue_scripts', 'load_INTENTclick_wp_admin_style');
add_action('admin_enqueue_scripts', 'INTENTclick_enqueue');
add_action('manage_posts_custom_column' , 'INTENTclick_show_columns');
add_action('quick_edit_custom_box',  'INTENTclick_add_quick_edit', 'INTENTclick');
add_action('save_post', 'INTENTclick_save_quick_edit_data');
add_action('bulk_edit_custom_box', 'INTENTclick_quick_edit_bulk');
add_action('submitpost_box', 'INTENTclick_block_content_link');
add_action('submitpage_box', 'INTENTclick_block_content_link');
add_action('edit_post', 'INTENTclick_write_post');
add_action('admin_menu', 'INTENTclick_menu');

?>
